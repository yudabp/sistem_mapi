<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PT API APPS - Data Keuangan Sub Perusahaan</title>

  <!-- Tailwind CDN (for quick nice UI) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF + html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Small custom */
    .card { background: #ffffffcc; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    input[readonly], textarea[readonly] { background: #f3f4f6; }
    .thumb { max-width: 80px; max-height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; }
    /* make table fixed header scrollable */
    .table-wrap { max-height: 360px; overflow: auto; }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

  <!-- Header -->
  <header class="bg-green-700 text-white py-4 shadow">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-bold">🌱 PT API APPS</div>
        <div class="text-sm opacity-90">— Sistem Manajemen Perkebunan</div>
      </div>
      <div class="text-sm">Page: <span class="font-semibold">Data Keuangan (Sub Perusahaan)</span></div>
    </div>
  </header>

  <!-- Main container -->
  <main class="container mx-auto px-4 py-6">

    <!-- Grid layout: left form, right summary -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Form Card -->
      <div class="card p-5 lg:col-span-2">
        <h3 class="text-xl font-semibold text-green-800 mb-4">Input Data Keuangan</h3>

        <form id="formTx" class="space-y-3">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm font-medium">Tanggal</label>
              <input id="txDate" type="date" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" required />
            </div>

            <div>
              <label class="text-sm font-medium">No. Transaksi (otomatis)</label>
              <input id="txNo" type="text" readonly class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
            </div>

            <div>
              <label class="text-sm font-medium">Tipe</label>
              <select id="txType" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" required>
                <option value="Pemasukan">Pemasukan</option>
                <option value="Pengeluaran">Pengeluaran</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Jumlah (Rp)</label>
              <input id="txAmount" type="number" min="0" step="1" placeholder="0" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" required />
            </div>

            <div>
              <label class="text-sm font-medium">Dari / Untuk</label>
              <input id="txFromTo" type="text" placeholder="Contoh: APR / Vendor ABC" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Diterima Oleh</label>
              <input id="txReceivedBy" type="text" placeholder="Nama penerima / petugas" class="mt-1 block w-full rounded-md border-gray-200 shadow-sm" />
            </div>

            <div>
              <label class="text-sm font-medium">Upload Bukti (gambar/pdf)</label>
              <input id="txFile" type="file" accept="image/*,application/pdf" class="mt-1 block w-full" />
            </div>
          </div>

          <div>
            <label class="text-sm font-medium">Catatan</label>
            <textarea id="txNote" rows="2" placeholder="Keterangan tambahan..." class="mt-1 block w-full rounded-md border-gray-200 shadow-sm"></textarea>
          </div>

          <div class="flex items-center gap-3 pt-2">
            <button id="btnSave" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">💾 Simpan</button>
            <button id="btnClear" type="button" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow">✖ Clear</button>
            <div class="ml-auto text-sm text-gray-600">* Gunakan form untuk input pemasukan atau pengeluaran</div>
          </div>
        </form>

      </div>

      <!-- Summary Card -->
      <aside class="card p-5">
        <h3 class="text-lg font-semibold text-green-800 mb-4">Rekap Keuangan (Ringkasan)</h3>

        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-600">Total Pemasukan</div>
              <div id="sumIncome" class="text-xl font-bold text-green-700">Rp 0</div>
            </div>
            <div>
              <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 1.567-3 3.5S10.343 15 12 15s3-1.567 3-3.5S13.657 8 12 8z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v3m0 12v3M4.2 6.3L6 8M18 16l1.8 1.7M4 18l1.8-1.7M18 8l1.8-1.7"></path>
              </svg>
            </div>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-gray-600">Total Pengeluaran</div>
              <div id="sumExpense" class="text-xl font-bold text-red-600">Rp 0</div>
            </div>
            <div>
              <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 12v9m0-9c1.657 0 3-1.567 3-3.5S13.657 6 12 6s-3 1.567-3 3.5S10.343 12 12 12z"></path>
              </svg>
            </div>
          </div>

          <div class="border-t pt-3">
            <div class="text-sm text-gray-600">Total Saldo</div>
            <div id="sumBalance" class="text-2xl font-extrabold text-indigo-700">Rp 0</div>
          </div>

          <div class="pt-4">
            <button id="exportCsv" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 rounded mb-2">⬇ Export CSV</button>
            <button id="exportPdf" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded">⬇ Export PDF</button>
          </div>
        </div>
      </aside>

    </div>

    <!-- Filters + Search -->
    <div class="mt-6 card p-4">
      <div class="flex flex-col md:flex-row md:items-center md:gap-4">
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Dari</label>
          <input id="filterFrom" type="date" class="rounded border-gray-200 px-2 py-1" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Sampai</label>
          <input id="filterTo" type="date" class="rounded border-gray-200 px-2 py-1" />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-700">Tipe</label>
          <select id="filterType" class="rounded border-gray-200 px-2 py-1">
            <option value="">Semua</option>
            <option value="Pemasukan">Pemasukan</option>
            <option value="Pengeluaran">Pengeluaran</option>
          </select>
        </div>
        <div class="flex items-center gap-2 ml-auto">
          <input id="searchText" type="search" placeholder="🔍 Cari (No trx / catatan / nama)" class="rounded border-gray-200 px-3 py-1 w-full md:w-80" />
          <button id="btnApplyFilter" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded">Apply</button>
          <button id="btnResetFilter" class="bg-gray-200 text-gray-700 px-3 py-1 rounded">Reset</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="mt-4 card p-4">
      <h4 class="font-semibold mb-3">Daftar Transaksi</h4>
      <div class="table-wrap">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left">No</th>
              <th class="px-3 py-2 text-left">Tanggal</th>
              <th class="px-3 py-2 text-left">No. Transaksi</th>
              <th class="px-3 py-2 text-left">Tipe</th>
              <th class="px-3 py-2 text-right">Jumlah (Rp)</th>
              <th class="px-3 py-2 text-left">Dari / Untuk</th>
              <th class="px-3 py-2 text-left">Diterima Oleh</th>
              <th class="px-3 py-2 text-left">Catatan</th>
              <th class="px-3 py-2 text-center">Bukti</th>
              <th class="px-3 py-2 text-center">Aksi</th>
            </tr>
          </thead>
          <tbody id="tbodyTx">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Templates & Scripts -->
  <script>
    // Simple in-memory storage
    let transactions = [];

    // Elements
    const txDate = document.getElementById('txDate');
    const txNo = document.getElementById('txNo');
    const txType = document.getElementById('txType');
    const txAmount = document.getElementById('txAmount');
    const txFromTo = document.getElementById('txFromTo');
    const txReceivedBy = document.getElementById('txReceivedBy');
    const txNote = document.getElementById('txNote');
    const txFile = document.getElementById('txFile');
    const btnSave = document.getElementById('btnSave');
    const btnClear = document.getElementById('btnClear');

    const tbodyTx = document.getElementById('tbodyTx');
    const sumIncomeEl = document.getElementById('sumIncome');
    const sumExpenseEl = document.getElementById('sumExpense');
    const sumBalanceEl = document.getElementById('sumBalance');

    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const filterType = document.getElementById('filterType');
    const searchText = document.getElementById('searchText');
    const btnApplyFilter = document.getElementById('btnApplyFilter');
    const btnResetFilter = document.getElementById('btnResetFilter');

    const exportCsv = document.getElementById('exportCsv');
    const exportPdf = document.getElementById('exportPdf');

    // Initialize date and txNo
    function initForm() {
      const today = new Date().toISOString().slice(0,10);
      txDate.value = today;
      txNo.value = generateTxNo();
    }
    function generateTxNo(){
      const now = new Date();
      return 'TRX' + now.getFullYear().toString().slice(-2) + 
             (now.getMonth()+1).toString().padStart(2,'0') +
             now.getDate().toString().padStart(2,'0') + '-' + now.getHours().toString().padStart(2,'0') + now.getMinutes().toString().padStart(2,'0') + now.getSeconds().toString().padStart(2,'0');
    }

    // Save transaction
    btnSave.addEventListener('click', (e) => {
      e.preventDefault();
      const date = txDate.value;
      const no = txNo.value || generateTxNo();
      const type = txType.value;
      const amount = parseInt(txAmount.value || 0);
      const fromto = txFromTo.value || '';
      const receivedBy = txReceivedBy.value || '';
      const note = txNote.value || '';
      const file = txFile.files[0] || null;

      // simple validation
      if (!date || !amount || amount <= 0) {
        alert('Mohon isi tanggal dan jumlah (Rp) yang valid.');
        return;
      }

      // read file preview as dataURL if exists
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          const dataUrl = evt.target.result;
          pushTransaction({ date,no,type,amount,fromto,receivedBy,note,fileName: file.name, fileData: dataUrl });
        };
        reader.readAsDataURL(file);
      } else {
        pushTransaction({ date,no,type,amount,fromto,receivedBy,note,fileName:'', fileData: '' });
      }
      // reset file input (clear)
      txFile.value = '';
      // reset other fields except date; txNo will be regenerated
      txAmount.value = '';
      txFromTo.value = '';
      txReceivedBy.value = '';
      txNote.value = '';
      txNo.value = generateTxNo();
    });

    btnClear.addEventListener('click', (e) => {
      e.preventDefault();
      txAmount.value = '';
      txFromTo.value = '';
      txReceivedBy.value = '';
      txNote.value = '';
      txFile.value = '';
      txType.value = 'Pemasukan';
      txNo.value = generateTxNo();
    });

    function pushTransaction(tx) {
      transactions.unshift(tx); // newest on top
      renderTable();
      updateSummary();
    }

    function renderTable(filtered = null) {
      const list = filtered || transactions;
      tbodyTx.innerHTML = '';
      list.forEach((t, idx) => {
        const tr = document.createElement('tr');

        const tdNo = `<td class="px-3 py-2 text-left">${idx+1}</td>`;
        const tdDate = `<td class="px-3 py-2 text-left">${t.date}</td>`;
        const tdTx = `<td class="px-3 py-2 text-left font-mono">${t.no}</td>`;
        const tdType = `<td class="px-3 py-2 text-left">${t.type}</td>`;
        const tdAmount = `<td class="px-3 py-2 text-right">Rp ${t.amount.toLocaleString()}</td>`;
        const tdFrom = `<td class="px-3 py-2 text-left">${escapeHtml(t.fromto)}</td>`;
        const tdRecv = `<td class="px-3 py-2 text-left">${escapeHtml(t.receivedBy)}</td>`;
        const tdNote = `<td class="px-3 py-2 text-left">${escapeHtml(t.note)}</td>`;
        let tdFile = `<td class="px-3 py-2 text-center">-</td>`;
        if (t.fileData) {
          // if image preview
          if (t.fileName.toLowerCase().match(/(png|jpg|jpeg|gif)$/)) {
            tdFile = `<td class="px-3 py-2 text-center"><img src="${t.fileData}" class="thumb" alt="bukti"></td>`;
          } else {
            tdFile = `<td class="px-3 py-2 text-center"><a href="${t.fileData}" download="${t.fileName}" class="text-blue-600 underline">Download</a></td>`;
          }
        }

        const tdAction = `<td class="px-3 py-2 text-center">
                            <button data-index="${idx}" class="deleteBtn bg-red-500 text-white px-2 py-1 rounded text-xs">Hapus</button>
                          </td>`;

        tr.innerHTML = tdNo + tdDate + tdTx + tdType + tdAmount + tdFrom + tdRecv + tdNote + tdFile + tdAction;
        tbodyTx.appendChild(tr);
      });

      // attach delete handlers
      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.onclick = function() {
          const i = parseInt(this.getAttribute('data-index'));
          // since we used unshift order, index corresponds to list index
          if (confirm('Hapus transaksi ini?')) {
            transactions.splice(i,1);
            renderTable();
            updateSummary();
          }
        }
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    function updateSummary(filteredList = null) {
      const list = filteredList || transactions;
      const income = list.filter(i => i.type === 'Pemasukan').reduce((s,x) => s + (x.amount||0), 0);
      const expense = list.filter(i => i.type === 'Pengeluaran').reduce((s,x) => s + (x.amount||0), 0);
      const balance = income - expense;

      sumIncomeEl.textContent = 'Rp ' + income.toLocaleString();
      sumExpenseEl.textContent = 'Rp ' + expense.toLocaleString();
      sumBalanceEl.textContent = 'Rp ' + balance.toLocaleString();
    }

    // Filtering & Searching
    btnApplyFilter.addEventListener('click', () => {
      const from = filterFrom.value;
      const to = filterTo.value;
      const type = filterType.value;
      const q = searchText.value.trim().toLowerCase();

      const filtered = transactions.filter(t => {
        if (from && t.date < from) return false;
        if (to && t.date > to) return false;
        if (type && t.type !== type) return false;
        if (q) {
          const hay = (t.no + ' ' + t.fromto + ' ' + t.receivedBy + ' ' + t.note).toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      renderTable(filtered);
      updateSummary(filtered);
    });

    btnResetFilter.addEventListener('click', () => {
      filterFrom.value = '';
      filterTo.value = '';
      filterType.value = '';
      searchText.value = '';
      renderTable();
      updateSummary();
    });

    // Export CSV (Excel-friendly)
    exportCsv.addEventListener('click', () => {
      if (transactions.length === 0) { alert('Tidak ada data untuk diexport.'); return; }
      const headers = ['Tanggal','NoTransaksi','Tipe','JumlahRp','Dari/Untuk','DiterimaOleh','Catatan','FileName'];
      const rows = transactions.map(t => [
        t.date, t.no, t.type, t.amount, `"${(t.fromto||'').replace(/"/g,'""')}"`, `"${(t.receivedBy||'').replace(/"/g,'""')}"`, `"${(t.note||'').replace(/"/g,'""')}"`, (t.fileName||'')
      ]);
      let csv = headers.join(',') + '\n';
      rows.forEach(r => csv += r.join(',') + '\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'data_keuangan_' + (new Date()).toISOString().slice(0,10) + '.csv';
      link.click();
    });

    // Export PDF (screenshot whole table area)
    exportPdf.addEventListener('click', async () => {
      // capture the card containing table and filters
      const el = document.querySelector('main');
      if (!el) return;
      const opt = { scale: 1.2, useCORS: true, logging: false };
      try {
        const canvas = await html2canvas(el, opt);
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('data_keuangan_' + (new Date()).toISOString().slice(0,10) + '.pdf');
      } catch (err) {
        alert('Gagal men-generate PDF: ' + err.message);
      }
    });

    // initialize with sample data (optional)
    function seedSample() {
      const sample = [
        { date:'2025-09-01', no: 'TRX250901-090001', type:'Pemasukan', amount: 50000000, fromto:'APR', receivedBy:'Budi', note:'Penjualan TBS', fileName:'', fileData:'' },
        { date:'2025-09-02', no: 'TRX250902-091530', type:'Pengeluaran', amount: 12000000, fromto:'Vendor Pupuk', receivedBy:'Sinta', note:'Beli pupuk', fileName:'', fileData:'' },
        { date:'2025-09-05', no: 'TRX250905-101200', type:'Pemasukan', amount: 25000000, fromto:'KPJ', receivedBy:'Andi', note:'Jual partai', fileName:'', fileData:'' }
      ];
      transactions = sample.concat(transactions);
      renderTable();
      updateSummary();
    }

    // on load
    initForm();
    seedSample();

  </script>
</body>
</html>
